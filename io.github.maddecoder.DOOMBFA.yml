app-id: io.github.maddecoder.Classic-RBDOOM-3-BFG
runtime: org.freedesktop.Platform
sdk: org.freedesktop.Sdk
runtime-version: "22.08"
command: DOOMBFA.sh
sdk-extensions:
    - org.freedesktop.Sdk.Extension.mono6
build-options:
    append-path: /usr/lib/sdk/mono6/bin
    append-ld-library-path: /usr/lib/sdk/mono6/lib
    append-pkg-config-path: /usr/lib/sdk/mono6/lib/pkgconfig
    # build-args:
    # - --share=network

finish-args:
- --device=all
- --socket=wayland
- --socket=x11
- --share=ipc
- --share=network
- --socket=pulseaudio
- --filesystem=~/.var/app:ro
- --filesystem=home
- --filesystem=/run/media:ro
- --filesystem=/media:ro
# - --talk-name=org.freedesktop.Flatpak
# - --talk-name=org.freedesktop.Notifications

cleanup:
- /include
- /lib/*.a
- /lib/*.la
- /lib/pkgconfig
- /lib/cmake
- /lib/debug
- /share/man
- /share/doc

modules:
- libdecor.yml
- xdg-util.yml
- libgdi.yml
- name: DoomBFA
  buildsystem: cmake
  subdir: neo
  builddir: true
  no-make-install: true
  config-opts:
   - --preset=linux-retail
   - -B .
   - -DMAKE_DLL=OFF
   - -DPACKAGED=ON
   - -DUSE_VCPKG=OFF
   - -DALL_STATIC=OFF
   - -DFFMPEG_FOUND=true
   - -DFFMPEG_AVCODEC_INCLUDE_DIR=/app/include
   - -DFFMPEG_LIBAVCODEC=/app/lib/libavcodec.so
   - -DFFMPEG_LIBAVFORMAT=/app/lib/libavformat.so
   - -DFFMPEG_LIBAVUTIL=/app/lib/libavutil.so
   - -DFFMPEG_LIBSWRESAMPLE=/app/lib/libswresample.so
   - -DFFMPEG_LIBSWSCALE=/app/lib/libswscale.so
   - -DOPENAL_FOUND=true
   - -DOPENAL_INCLUDE_DIR=/app/include
   - -DOPENAL_LIBRARY=/app/lib/libopenal.so
   - -DOPENAL_VERSION_STRING=1.23.1
   - -DUSE_SYSTEM_ZLIB=false
   - -DZLIB_FOUND=true
   - -DZLIB_INCLUDE_DIRS=/app/include
   - -DZLIB_LIBRARIES=/app/lib/libz.so
   - -DUSE_SYSTEM_LIBPNG=false
   - -DPNG_FOUND=true
   - -DPNG_INCLUDE_DIRS=/app/include
   - -DPNG_LIBRARIES=/app/lib/libpng.so
   - -DUSE_SYSTEM_LIBJPEG=false
   - -DJPEG_FOUND=true
   - -DJPEG_INCLUDE_DIRS=/app/include
   - -DJPEG_LIBRARIES=/app/lib64/libjpeg.so
   - -DSDL2_INCLUDE_DIR=/app/include/SDL2
   - -DSDL2_LIBRARY=/app/lib/libSDL2.so;/app/lib/libSDL2main.a
  sources:
  - type: git
    url: https://github.com/MadDeCoDeR/Classic-RBDOOM-3-BFG.git
    commit: 2fa4c8abfa4b0d76c708718c94558820877450b7
    disable-submodules: true
  modules:
    - shared-modules/glew/glew.json
    - shared-modules/glu/glu-9.json
    - shared-modules/SDL2/SDL2-with-libdecor.json
    - openal.json
    - ffmpeg.json
    - zlib.json
    - libpng.json
    - libjpeg-turbo.json
    - rapidjson.json
  build-commands:
    - install -Dm 755 DoomBFA /app/bin/DoomBFA
    # - mkdir -p /app/share/third-party-licenses
    # - zip tpl.zip vcpkg_installed/x64-linux/share/*/copyright
    # - mv tpl.zip /app/share
    # - unzip /app/share/tpl.zip -d /app/share/third-party-licenses
    # - mv /app/share/third-party-licenses/vcpkg_installed/x64-linux/share/* /app/share/third-party-licenses
    # - rm /app/share/tpl.zip
    # - rm -R /app/share/third-party-licenses/vcpkg_installed
    - mkdir -p /app/share/games/doombfa
    - cp -R ../../base /app/share/games/doombfa/base
    - cp -R ../../base_new /app/share/games/doombfa/base_NEW

- name: CDL
  buildsystem: simple
  sources:
  - type: archive
    url: https://github.com/MadDeCoDeR/CRBDL/releases/download/1.0.1.6-21/CDL.zip
    sha512: d4866b7fc1b244a8bfd30c61ff6cbccf1db0f5b05e7506741c70c02cabddc52b67fab5d872ba1dd8992135d1930e4b96e89e073e4a381fbbd1202bbc073a7e1e
  - type: file
    path: install-mono.sh
  build-commands:
  - install -Dm 755 CDL.exe /app/bin/CDL.exe
  - ./install-mono.sh

- name: DoomBFA-assets
  buildsystem: simple
  sources:
  - type: git
    url: https://github.com/MadDeCoDeR/BFA-Assets.git
  - type: file
    path: appdata.xml
  - type: file
    path: DOOMBFA.desktop
  - type: file
    path: doom.png
  - type: file
    path: DOOMBFA.sh
  build-commands:
    - install -Dm 644 DOOMBFA.desktop /app/share/applications/${FLATPAK_ID}.desktop
    - install -Dm 644 doom.png /app/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png
    - mkdir -p /app/share/games/doombfa
    - cp -R base/* /app/share/games/doombfa/base
    - cp -R base_BFG /app/share/games/doombfa/base_BFG
    - mkdir -p /app/share/metainfo
    - install -Dm 644 appdata.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
    - install -Dm 755 DOOMBFA.sh /app/bin/DOOMBFA.sh
    # - install -Dm 644 README.md /app/share/third-party-licenses/README.md
